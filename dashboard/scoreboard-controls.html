<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<script src="js/bootstrap.bundle.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<style>
			.monospace {
				font-family: monospace;
			}
		</style>
	</head>
	<body class="bg-dark text-white">
		<br />
		<div class="container-fluid">
			<h4 id="scoreboardMatchNameDisplay"></h4>
			<div class="input-group mb-3">
				<input
					type="number"
					class="form-control"
					value="0"
					min="0"
					style="max-width: 10%"
					id="team1score"
					placeholder="[KE] Derf"
				/>
				<input
					type="number"
					class="form-control"
					value="0"
					style="max-width: 10%"
					min="0"
					id="team2score"
					placeholder="[ACE] Jokers"
				/>
				<div class="input-group-text">
					<input
						class="form-check-input mt-0"
						type="checkbox"
						id="matchComplete"
					/>
				</div>
				<span class="input-group-text">Match Complete?</span>
				<button
					class="btn btn-danger"
					id="resetBtn"
					onclick="resetScores()"
				>
					Reset
				</button>
				<button
					class="btn btn-success"
					id="updateBtn"
					onclick="saveMatch()"
				>
					Update
				</button>
			</div>
		</div>

		<hr />
		<div class="container-fluid">
			<div class="input-group mb-3">
				<select
					class="form-select"
					name="scoreboardSelectMatch"
					id="scoreboardSelectMatch"
				></select>
				<button class="btn btn-success" onclick="loadMatch()">
					Load Match
				</button>
			</div>
		</div>
	</body>

	<script>
		let loadedMatch = null;
		let loadedMatchIndex = -1;
		const matches = nodecg.Replicant("matchList");

		const scoreboardSelectMatch = document.getElementById(
			"scoreboardSelectMatch"
		);

		matches.on("change", (matchList) => {
			console.log("Match List changed");

			/* Remove all options from the select list */
			$("#scoreboardSelectMatch").empty();

			/* Insert the new ones from the array above */
			$.each(matchList, function (value) {
				var ele = document.createElement("option");
				const match = matchList[value];
				console.log("Match Data", match);
				ele.text = match.team1 + " vs " + match.team2;
				ele.id = value;
				$("#scoreboardSelectMatch").append(ele);
			});
			if (loadedMatch == null) loadMatch();
			updateDisplay();
		});

		function updateDisplay() {
			$("#scoreboardMatchNameDisplay").text(
				loadedMatch.team1 + " vs " + loadedMatch.team2
			);
			$("#team1score").attr("placeholder", loadedMatch.team1);
			$("#team2score").attr("placeholder", loadedMatch.team2);

			// Reset background colours
			$("#team1score").css("background-color", "");
			$("#team2score").css("background-color", "");

			if (loadedMatch.matchCompleted) {
				if (loadedMatch.team1score > loadedMatch.team2score)
					$("#team1score").css("background-color", "lime");
				else if (loadedMatch.team2score > loadedMatch.team1score)
					$("#team2score").css("background-color", "lime");
				else if (loadedMatch.team1score == loadedMatch.team2score) { // if a tie- they both light up
					$("#team1score").css("background-color", "lime");
					$("#team2score").css("background-color", "lime");
				}
			}
		}

		function saveMatch() {
			loadedMatch.matchCompleted = $("#matchComplete").prop("checked");
			loadedMatch.team1score = $("#team1score").val();
			loadedMatch.team2score = $("#team2score").val();
			console.log("Saved the following Match data", loadedMatch);
		}

		function resetScores() {
			document.getElementById("team1score").value = 0;
			document.getElementById("team2score").value = 0;
			document.getElementById("matchComplete").checked = false;
			saveMatch();
		}

		function loadMatch() {
			const selectedMatch = scoreboardSelectMatch.selectedIndex;
			loadedMatchIndex = scoreboardSelectMatch.selectedIndex;
			loadedMatch = matches.value[selectedMatch];
			console.log("Loading Match", loadedMatch);
			$("#team1score").val(loadedMatch.team1score || 0);
			$("#team2score").val(loadedMatch.team2score || 0);
			$("#matchComplete").prop(
				"checked",
				loadedMatch.matchCompleted || false
			);
			updateDisplay();
		}
	</script>
</html>
